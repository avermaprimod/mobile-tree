<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
        <title>SlickGrid example 5: Collapsing</title>
        <link rel="stylesheet" href="../slick.grid.css" type="text/css"/>
        <!--link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/-->
        <!--link rel="stylesheet" href="examples.css" type="text/css"/-->
        <link rel="stylesheet" href="example-bootstrap.css" type="text/css"/>
        <link rel="stylesheet" href="bootstrap.css" type="text/css"/>
        <style>
            .cell-title {
                font-weight: bold;
            }

            .cell-effort-driven {
                text-align: center;
            }

            .toggle {
                height: 9px;
                width: 9px;
                display: inline-block;
            }

            .toggle.expand {
                background: url(../images/expand.gif) no-repeat center center;
            }

            .toggle.collapse {
                background: url(../images/collapse.gif) no-repeat center center;
            }

        </style>
    </head>
    <body>
        <div id="myGrid" class="grid"></div>


        <script src="../lib/firebugx.js"></script>

        <script src="../lib/jquery-1.7.min.js"></script>
        <script src="../lib/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="../lib/jquery.event.drag-2.2.js"></script>

        <script src="../slick.core.js"></script>
        <script src="../slick.formatters.js"></script>
        <script src="../slick.editors.js"></script>
        <script src="../slick.grid.js"></script>
        <script src="../slick.dataview.js"></script>
        <script src="bootstrap-slickgrid.js"></script>


        <script>
            function requiredFieldValidator(value) {
                if (value == null || value == undefined || !value.length) {
                    return {valid: false, msg: "This is a required field"};
                } else {
                    return {valid: true, msg: null};
                }
            }


            var TaskNameFormatter = function(row, cell, value, columnDef, dataContext) {
                value = value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var spacer = "<span style='display:inline-block;height:1px;width:" + (15 * dataContext["indent"]) + "px'></span>";
                var idx = dataView.getIdxById(dataContext.id);
                if (data[idx + 1] && data[idx + 1].indent > data[idx].indent) {
                    if (dataContext._collapsed) {
                        return spacer + " <span class='toggle expand'></span>&nbsp;" + value;
                    } else {
                        return spacer + " <span class='toggle collapse'></span>&nbsp;" + value;
                    }
                } else {
                    return spacer + " <span class='toggle'></span>&nbsp;" + value;
                }
            };

            var dataView;
            var grid;
            var data = [];
            var columns = [
                {id: "title", name: "Title", field: "title", width: 300, cssClass: "cell-title", formatter: TaskNameFormatter},
                {id: "duration", name: "Duration", field: "duration", minWidth: 150},
                {id: "start", name: "Start", field: "start", minWidth: 150},
                {id: "finish", name: "Finish", field: "finish", minWidth: 150}

            ];

            var options = {
            };

            var percentCompleteThreshold = 0;
            var searchString = "";

            function myFilter(item) {
                if (item["percentComplete"] < percentCompleteThreshold) {
                    return false;
                }

                if (searchString != "" && item["title"].indexOf(searchString) == -1) {
                    return false;
                }

                if (item.parent != null) {
                    var parent = data[item.parent];

                    while (parent) {
                        if (parent._collapsed || (parent["percentComplete"] < percentCompleteThreshold) || (searchString != "" && parent["title"].indexOf(searchString) == -1)) {
                            return false;
                        }

                        parent = data[parent.parent];
                    }
                }

                return true;
            }

            function percentCompleteSort(a, b) {
                return a["percentComplete"] - b["percentComplete"];
            }

            $(function() {
                $.ajax({
                    url: "http://uat.maaxframe.com/access_controls/users.json",
                    type: "POST",
                    data: {"_method": "login", "data[users][user_name]": "timlee", "data[users][user_password]": "timlee"},
                    contentType: "application/x-www-form-urlencoded",
                    success: function(response) {
                        console.log(response)
                    }
                });
                var treedata = [];

                $.ajax('http://uat.maaxframe.com/development_base/menus.json', {
                    type: 'GET',
                    data: {"current_listview": "52611fb5-a93c-4fe3-8d3e-1d890acef1b9", "_method": "index", "q": {"limit": "0", "fetch_first_level": "0", "where": [{"menus.lft >": "0", "menus.rgt <": "20000000"}]}},
                    contentType: 'application/x-www-form-urlencoded',
                    success: function(response) {
                        console.log(response['paginate']['data'])
                        var rows = response['paginate']['data'];
                        console.log(rows)
                        var length = rows.length;
                        if (length > 0) {
                            var row = {};
                            $.each(rows[0], function(i, v) {
                                console.log(i)
                                row[i] = i.replace('menus.', '');
                            });
                        }
                        var records = [];
                        for (recordNo = 0; recordNo < length; recordNo++) {
                            records[recordNo] = {};
                            $.each(rows[recordNo], function(i, v) {
                                records[recordNo][row[i]] = v;
                            });
                        }
                        console.log(records);

                    }
                });



                var indent = 0;
                var parents = [];

                // prepare the data
                for (var i = 0; i < 1000; i++) {
                    var d = (data[i] = {});
                    var parent;

                    if (Math.random() > 0.8 && i > 0) {
                        indent++;
                        parents.push(i - 1);
                    } else if (Math.random() < 0.3 && indent > 0) {
                        indent--;
                        parents.pop();
                    }

                    if (parents.length > 0) {
                        parent = parents[parents.length - 1];
                    } else {
                        parent = null;
                    }
                    d["_collapsed"] = true;
                    d["id"] = "id_" + i;
                    d["indent"] = indent;
                    d["parent"] = parent;
                    d["title"] = "Task " + i;
                    d["duration"] = "5 days";

                    d["start"] = "01/01/2009";
                    d["finish"] = "01/05/2009";

                }


                // initialize the model
                dataView = new Slick.Data.DataView({inlineFilters: true});
                dataView.beginUpdate();
                console.log(data);
                dataView.setItems(data);
                dataView.setFilter(myFilter);
                dataView.endUpdate();


                // initialize the grid
                grid = new Slick.Grid("#myGrid", dataView, columns, options);

                grid.onCellChange.subscribe(function(e, args) {
                    dataView.updateItem(args.item.id, args.item);
                });

                grid.onAddNewRow.subscribe(function(e, args) {
                    var item = {
                        "id": "new_" + (Math.round(Math.random() * 10000)),
                        "indent": 0,
                        "title": "New task",
                        "duration": "1 day",
                        "percentComplete": 0,
                        "start": "01/01/2009",
                        "finish": "01/01/2009",
                        "effortDriven": false};
                    $.extend(item, args.item);
                    dataView.addItem(item);
                });

                grid.onClick.subscribe(function(e, args) {
                    if ($(e.target).hasClass("toggle")) {
                        var item = dataView.getItem(args.row);
                        if (item) {
                            if (!item._collapsed) {
                                item._collapsed = true;
                            } else {
                                item._collapsed = false;
                            }

                            dataView.updateItem(item.id, item);
                        }
                        e.stopImmediatePropagation();
                    }
                });


                // wire up model events to drive the grid
                dataView.onRowCountChanged.subscribe(function(e, args) {
                    grid.updateRowCount();
                    grid.render();
                });

                dataView.onRowsChanged.subscribe(function(e, args) {
                    grid.invalidateRows(args.rows);
                    grid.render();
                });


                var h_runfilters = null;

                // wire up the slider to apply the filter to the model
                $("#pcSlider").slider({
                    "range": "min",
                    "slide": function(event, ui) {
                        Slick.GlobalEditorLock.cancelCurrentEdit();

                        if (percentCompleteThreshold != ui.value) {
                            window.clearTimeout(h_runfilters);
                            h_runfilters = window.setTimeout(dataView.refresh, 10);
                            percentCompleteThreshold = ui.value;
                        }
                    }
                });


                // wire up the search textbox to apply the filter to the model
                $("#txtSearch").keyup(function(e) {
                    Slick.GlobalEditorLock.cancelCurrentEdit();

                    // clear on Esc
                    if (e.which == 27) {
                        this.value = "";
                    }

                    searchString = this.value;
                    dataView.refresh();
                })
            })
        </script>
    </body>
</html>
